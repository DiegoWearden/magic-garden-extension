<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Inspector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            line-height: 1.4;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            padding: 20px;
            overflow-y: auto;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: #2d2d30;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-input {
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .file-input:hover {
            background: #404040;
        }

        .path-input {
            flex: 1;
            min-width: 300px;
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            position: relative;
        }

        .path-input:focus {
            outline: none;
            border-color: #007acc;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #3e3e42;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .autocomplete-item:hover {
            background: #404040;
        }

        .autocomplete-item.selected {
            background: #007acc;
        }

        .path-container {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .monitoring-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #4caf50;
            margin-left: 10px;
        }

        .monitoring-dot {
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .btn {
            background: #0e639c;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background: #1177bb;
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .content {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .json-tree {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .json-node {
            margin: 2px 0;
        }

        .json-key {
            color: #9cdcfe;
            font-weight: bold;
        }

        .json-value {
            color: #ce9178;
        }

        .json-string {
            color: #ce9178;
        }

        .json-number {
            color: #b5cea8;
        }

        .json-boolean {
            color: #569cd6;
        }

        .json-null {
            color: #808080;
            font-style: italic;
        }

        .json-object {
            color: #d4d4d4;
        }

        .json-array {
            color: #d4d4d4;
        }

        .toggle {
            cursor: pointer;
            user-select: none;
            display: inline-block;
            width: 16px;
            text-align: center;
            margin-right: 4px;
        }

        .toggle:hover {
            background: #404040;
            border-radius: 2px;
        }

        .collapsed {
            display: none;
        }

        .indent {
            margin-left: 20px;
        }

        .bracket {
            color: #d4d4d4;
        }

        .comma {
            color: #d4d4d4;
        }

        .path-breadcrumb {
            background: #2d2d30;
            padding: 10px 20px;
            border-bottom: 1px solid #3e3e42;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: #9cdcfe;
        }

        .path-segment {
            cursor: pointer;
            color: #9cdcfe;
            text-decoration: underline;
        }

        .path-segment:hover {
            color: #4fc1ff;
        }

        .error {
            color: #f44747;
            background: #2d1b1b;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .info {
            color: #4ec9b0;
            background: #1b2d1b;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .stats {
            background: #2d2d30;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }

        .search-box {
            width: 100%;
            background: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #d4d4d4;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .highlight {
            background: #ffeb3b;
            color: #000;
            padding: 1px 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h3>JSON Inspector</h3>
            <div style="display:flex;gap:8px;align-items:center;">
                <input type="file" id="fileInput" class="file-input" accept=".json" />
                <button id="openFsButton" class="btn" title="Open using File System Access API (enables live updates)">Open (filesystem)</button>
            </div>
            <div class="stats" id="stats">
                <div>No file loaded</div>
            </div>
            <div>
                <h4>Search</h4>
                <input type="text" id="searchInput" class="search-box" placeholder="Search in JSON..." />
            </div>
                <div>
                    <h4>Quick Access</h4>
                    <div id="quickAccess">
                        <button class="btn" onclick="navigateToPath('')">Root</button>
                        <button class="btn" onclick="navigateToPath('data')">Data</button>
                        <button class="btn" onclick="navigateToPath('data/child')">Child</button>
                    </div>
                </div>
        </div>
        
        <div class="main">
            <div class="toolbar">
                <input type="file" id="fileInput2" class="file-input" accept=".json" />
                <button id="openFsButton2" class="btn" title="Open using File System Access API (enables live updates)">Open (filesystem)</button>
                <div class="path-container">
                    <input type="text" id="pathInput" class="path-input" placeholder="Enter JSON path (e.g., data/child/userSlots/0)" />
                    <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
                </div>
                <div id="monitoringIndicator" class="monitoring-indicator" style="display: none;">
                    <div class="monitoring-dot"></div>
                    <span>Live</span>
                </div>
                <button class="btn" onclick="navigateToPath()">Navigate</button>
                <button class="btn" onclick="refreshFile()" title="Manually refresh the file">Refresh</button>
                <button class="btn" onclick="expandAll()">Expand All</button>
                <button class="btn" onclick="collapseAll()">Collapse All</button>
                <button class="btn" onclick="copyPath()">Copy Path</button>
            </div>
            
            <div class="path-breadcrumb" id="pathBreadcrumb">
                <span class="path-segment" onclick="navigateToPath('')">root</span>
            </div>
            
            <div class="content">
                <div id="jsonContent">
                    <div class="info">
                        <h3>Welcome to JSON Inspector</h3>
                        <p>1. Load a JSON file using the file input</p>
                        <p>2. Use the path input to navigate to specific parts</p>
                        <p>3. Click arrows to expand/collapse sections</p>
                        <p>4. Use search to find specific values</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let jsonData = null;
        let currentPath = '';
        let searchTerm = '';
        let autocompleteItems = [];
        let selectedAutocompleteIndex = -1;
        let currentFile = null; // legacy File from input (snapshot)
        let fileHandle = null;   // File System Access API handle (live)
        let fileWatcher = null;
        let lastModified = null;

        // File input handlers
        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById('fileInput2').addEventListener('change', handleFile);
        document.getElementById('openFsButton').addEventListener('click', openFileWithHandle);
        document.getElementById('openFsButton2').addEventListener('click', openFileWithHandle);

        // Path input handler
        const pathInput = document.getElementById('pathInput');
        pathInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (selectedAutocompleteIndex >= 0 && autocompleteItems[selectedAutocompleteIndex]) {
                    pathInput.value = autocompleteItems[selectedAutocompleteIndex].path;
                    hideAutocomplete();
                    navigateToPath();
                } else {
                    navigateToPath();
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectNextAutocomplete();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectPrevAutocomplete();
            } else if (e.key === 'Escape') {
                hideAutocomplete();
            }
        });

        pathInput.addEventListener('input', function(e) {
            showAutocomplete(e.target.value);
        });

        // Click outside to hide autocomplete
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.path-container')) {
                hideAutocomplete();
            }
        });

        // Search input handler
        document.getElementById('searchInput').addEventListener('input', function(e) {
            searchTerm = e.target.value.toLowerCase();
            renderJson();
        });

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            currentFile = file;
            lastModified = file.lastModified;
            
            // Stop previous file watcher
            if (fileWatcher) {
                clearInterval(fileWatcher);
                fileWatcher = null;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    jsonData = JSON.parse(e.target.result);
                    currentPath = '';
                    updateStats();
                    renderJson();
                    updateBreadcrumb();
                    // Legacy File input: monitoring via file input is not live (snapshot). Keep manual refresh.
                    stopFileMonitoring();
                } catch (error) {
                    showError('Invalid JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Open file using the File System Access API (enables live monitoring when supported)
        async function openFileWithHandle() {
            if (!window.showOpenFilePicker) {
                alert('File System Access API not available in this browser. Use the file input instead.');
                return;
            }

            try {
                const [handle] = await window.showOpenFilePicker({ types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }] });
                if (!handle) return;

                fileHandle = handle;

                // Attempt to get read permission
                if (await allowRead(fileHandle)) {
                    await readFileFromHandle();
                    startFileMonitoring();
                } else {
                    alert('Permission to read the file was not granted.');
                }
            } catch (err) {
                console.warn('openFileWithHandle cancelled or failed:', err);
            }
        }

        async function allowRead(handle) {
            if (!handle.queryPermission) return true;
            const qp = await handle.queryPermission({ mode: 'read' });
            if (qp === 'granted') return true;
            const req = await handle.requestPermission({ mode: 'read' });
            return req === 'granted';
        }

        async function readFileFromHandle() {
            if (!fileHandle) return;
            try {
                const file = await fileHandle.getFile();
                const text = await file.text();
                jsonData = JSON.parse(text);
                currentFile = null; // clear legacy snapshot
                lastModified = file.lastModified;
                currentPath = '';
                updateStats();
                renderJson();
                updateBreadcrumb();
                showFileChangeNotification('File opened via filesystem (live monitoring enabled)');
            } catch (err) {
                showError('Error reading file: ' + err.message);
            }
        }

        function startFileMonitoring() {
            // Only enable true live monitoring when we have a File System Access handle
            if (!fileHandle) {
                console.log('Live monitoring requires File System Access API file handle. Use "Open (filesystem)".');
                const indicator = document.getElementById('monitoringIndicator');
                if (indicator) indicator.style.display = 'none';
                return;
            }

            // Clear any previous watcher
            if (fileWatcher) clearInterval(fileWatcher);

            // Check for file changes every 1000ms
            fileWatcher = setInterval(async () => {
                await checkHandleChanges();
            }, 1000);

            // Show monitoring indicator
            const indicator = document.getElementById('monitoringIndicator');
            if (indicator) {
                indicator.style.display = 'inline-flex';
            }

            console.log('Started monitoring file handle for changes...');
        }

        function stopFileMonitoring() {
            if (fileWatcher) {
                clearInterval(fileWatcher);
                fileWatcher = null;
            }
            const indicator = document.getElementById('monitoringIndicator');
            if (indicator) indicator.style.display = 'none';
        }

        async function refreshFile() {
            // If we have a file handle, read from it (live)
            if (fileHandle) {
                await readFileFromHandle();
                showFileChangeNotification('File manually refreshed (filesystem)');
                return;
            }

            // Otherwise fall back to legacy file input snapshot
            if (!currentFile) {
                alert('No file loaded to refresh');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const newData = JSON.parse(e.target.result);
                    const pathToRestore = currentPath;

                    // Update data
                    jsonData = newData;
                    lastModified = currentFile.lastModified;

                    // Restore path and re-render
                    currentPath = pathToRestore;
                    updateStats();
                    renderJson();
                    updateBreadcrumb();

                    // Show notification
                    showFileChangeNotification('File manually refreshed');
                } catch (error) {
                    showError('Error refreshing file: ' + error.message);
                }
            };
            reader.readAsText(currentFile);
        }

        // Polling function for File System Access handle
        async function checkHandleChanges() {
            if (!fileHandle) return;
            try {
                const file = await fileHandle.getFile();
                if (file.lastModified !== lastModified) {
                    lastModified = file.lastModified;
                    const text = await file.text();
                    try {
                        const newData = JSON.parse(text);
                        const pathToRestore = currentPath;
                        jsonData = newData;
                        currentPath = pathToRestore;
                        updateStats();
                        renderJson();
                        updateBreadcrumb();
                        showFileChangeNotification();
                    } catch (parseErr) {
                        console.warn('Failed to parse updated JSON:', parseErr);
                    }
                }
            } catch (err) {
                console.warn('Error checking file handle:', err);
            }
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopFileMonitoring();
        });
    </script>
</body>
</html>
